---
title: "Graph"
author: "Tommy Schupp"
date: "2024-01-10"
output: html_document
---

```{r}
library(igraph)
library(tidyverse)
donations = read_csv("../../large_contributions_and_scores.csv", n_max = 500000)
individual_donations = donations %>%
  filter(pac_or_individual == 'i')

pac_donations = donations %>%
  filter(pac_or_individual == 'p')
```

```{r}
edge_list <- individual_donations %>%
  select(donor_name, candidate_name, amount)

g <- graph_from_data_frame(d=edge_list, directed=FALSE)

V(g)$type <- bipartite_mapping(g)$type

donor_candidate_amount <- edge_list %>%
  group_by(donor_name, candidate_name) %>%
  summarize(total_amount = sum(amount))


candidate_pairs <- donor_candidate_amount %>%
  full_join(donor_candidate_amount, by="donor_name") %>%
  filter(candidate_name.x != candidate_name.y) %>%
  group_by(candidate_name.x, candidate_name.y) %>%
  summarize(weight = sum(total_amount.x + total_amount.y))

candidate_projection <- bipartite_projection(g, which=TRUE)
V(candidate_projection)$name <- V(g)[V(g)$type == TRUE]$name

E(candidate_projection)$weight <- 0
for (i in 1:nrow(candidate_pairs)) {
  pair <- candidate_pairs[i, ]
  edge <- get.edge.ids(candidate_projection, 
                       c(pair$candidate_name.x, pair$candidate_name.y))
  E(candidate_projection)[edge]$weight <- pair$weight
}

plot(candidate_projection, 
     edge.width=E(candidate_projection)$weight / max(E(candidate_projection)$weight) * 5, 
     vertex.label=V(candidate_projection)$name, 
     vertex.size=15, 
     edge.arrow.size=0, 
     edge.curved=0.1, 
     layout=layout_nicely(candidate_projection)
)

```


